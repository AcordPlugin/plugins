(function(y,D,m,v,w,C,b){"use strict";function l(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var x=l(y),U=l(m),p=l(v),u=l(w),h=l(C);const{React:E,TypingStore:f,UserStore:_}=U.default,i=x.default("https://ccwss.armagan.rest/typing-indicators",{transports:["websocket"]});i.on("connect",()=>{i.emit(":setUser",{userId:_.getCurrentUser().id})}),i.on(":kill",()=>{i.disconnect()});function k(e,t,a=1/0){return new Promise(r=>{let s=!1;i.emit(e,t,d=>{s||r(d)}),a!=1/0&&setTimeout(()=>{s=!0,r({ok:!1,error:"Timeout"})},a)})}class T{constructor(){this.patches=[]}add(...t){this.patches.push(...t)}remove(t){let[a]=this.patches.splice(this.patches.indexOf(r=>r==t),1);a()}removeAll(){let t=this.patches.splice(0,this.patches.length);for(let a=0;a<t.length;a++)t[a]()}}var c=new T;const n={typingUsers:[],requestCache:[],responseCache:new Map};async function I(e){let t=n.typingUsers.includes(e);if(!t){let a=n.responseCache.get(`Users:${e}`);if(a)return a.state;t=await new Promise(r=>{n.requestCache.push([e,r])}),n.responseCache.set(`Users:${e}`,{at:Date.now(),state:t,ttl:1e3})}return t}function L(){c.add(p.default.patch('[class*="layout-"] [class*="avatar-"] [class*="wrapper-"], [class*="userInfo-"] [class*="avatar-"] [class*="wrapper-"]',e=>{let t=p.default.parents(e,"[data-list-item-id]")?.[0];if(!t)return;let a=u.default.react.getProps(t,o=>o?.user)?.user;if(!a)return;t.classList.add("ti--wrapper");let r=t.getBoundingClientRect(),s=e.getBoundingClientRect(),d=p.default.parseHTML(`
                    <div class="ti--container" style="left: ${s.left-r.left}px; top: ${s.top-r.top}px; width: ${s.width}px; height: ${s.height}px;">
                        <img src="https://i.imgur.com/khSp0aH.gif"></img>
                    </div>
                `);t.appendChild(d);let g=null;async function O(){let o=await I(a.id);g!==o&&(d.classList[o?"add":"remove"]("visible"),g=o)}return h.default.on("TypingIndicators:1s",O)}))}var S=()=>b.injectCSS(".ti--wrapper{position:relative}.ti--container{display:flex;align-items:center;justify-content:center;position:absolute;top:0;left:0;border-radius:50%;z-index:98;display:none}.ti--container.visible{display:flex!important}.ti--container img{opacity:.95;background-color:#000000bf;box-shadow:0 0 2px #000;padding:2px;border-radius:99px;width:22px}");function j(){c.add(S())}function R(){c.add((()=>{function e(){let t=Object.keys(Object.values(f.__getLocalVars().typingUsersByChannel).reduce((a,r)=>(Object.entries(r).forEach(s=>{a[s[0]]=s[1]}),a),{}));i.emit("typings",{ok:!0,data:t}),n.typingUsers=t}return f.addChangeListener(e),()=>{f.removeChangeListener(e),n.typingUsers=[],n.responseCache.clear()}})()),c.add(u.default.interval(async()=>{if(n.requestCache[0]){let e=[...n.requestCache];n.requestCache=[],((await k("bulkTyping",e.map(a=>a[0])))?.data||[]).forEach(a=>{e.filter(s=>s[0]===a[0]).forEach(s=>{s[1](a[1]||!1)})})}},100)),c.add(u.default.interval(()=>{n.responseCache.forEach((e,t)=>{Date.now()-e.at>e.ttl&&n.responseCache.delete(t)})},1e3))}function $(){c.add((()=>{let e=setInterval(()=>{h.default.emit("TypingIndicators:1s")},1e3);return()=>{clearInterval(e)}})())}var q={load(){L(),j(),R(),$(),i.connect()},unload(){c.removeAll(),i.disconnect()}};return q})(io,acord.modules.webpack,acord.modules.common,acord.dom,acord.utils,acord.events,acord.patcher);
