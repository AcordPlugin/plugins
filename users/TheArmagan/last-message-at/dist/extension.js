(function(w,_,v,M,T,g,A){"use strict";function i(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}var I=i(w),E=i(_),n=i(v),d=i(M),m=i(T),D=i(A);const{FluxDispatcher:C,UserStore:u,ChannelStore:L,GuildStore:k}=E.default,s=I.default("https://ccwss.armagan.rest/last-message-at",{transports:["websocket"]});s.on("connect",()=>{s.emit(":setUser",{userId:u.getCurrentUser().id})}),s.on(":kill",()=>{s.disconnect()});function P(t,e,a=1/0){return new Promise(r=>{let l=!1;s.emit(t,e,o=>{l||r(o)}),a!=1/0&&setTimeout(()=>{l=!0,r({ok:!1,error:"Timeout"})},a)})}class x{constructor(){this.patches=[]}add(...e){this.patches.push(...e)}remove(e){let[a]=this.patches.splice(this.patches.indexOf(r=>r==e),1);a()}removeAll(){let e=this.patches.splice(0,this.patches.length);for(let a=0;a<e.length;a++)e[a]()}}var c=new x;async function y(t){let e=(await P("at",{id:t}))?.data||null;return e?Array.isArray(e)?e:[e]:null}let U=d.default.findByProps("section","lastSection"),f=d.default.findByProps("defaultColor","lineClamp1"),$=d.default.findByProps("eyebrow","display-lg","display-md"),S=d.default.find(t=>t?.defaultColor&&Object.keys(t).length==1),p=d.default.find(t=>t?.title&&t?.body&&Object.keys(t).length==2);function b(t){let e=new Date(t);return`${e.toLocaleString(D.default.locale,{month:"short"})} ${new Date().getDate().toString().padStart(2,"0")}, ${e.getFullYear()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}function B(){c.add(n.default.patch('[class*="userPopoutInner-"] [class*="memberSinceContainer-"]',async t=>{let e=n.default.parents(t,'[class*="section-"]')?.[0]?.parentElement;if(!e)return;let a=m.default.react.getProps(t,o=>o?.user)?.user;if(!a)return;let r=await y(a.id);if(!r)return;let l=n.default.parseHTML(`
                    <div class="${U.section}">
                        <h2 class="${f.defaultColor} ${$.eyebrow} ${S.defaultColor} ${p.title}">${g.i18n.format("LAST_MESSAGE_AT")}</h2>
                        <div class="${f.defaultColor} ${p.body}" style="user-select: text; width: fit-content;" acord--tooltip-content="${n.default.escapeHTML(r[1])}">${b(r[0])}</div>
                    </div>
                `);e.insertBefore(l,e.children[1])})),c.add(n.default.patch('[class*="userProfileModalInner-"] [class*="memberSinceContainer-"]',async t=>{let e=n.default.parents(t,'[class*="userInfoSection-"]')?.[0];if(!e)return;let a=m.default.react.getProps(t,O=>O?.user)?.user;if(!a)return;let r=await y(a.id);if(!r)return;let l=n.default.parseHTML(`
                    <h2 class="${f.defaultColor} ${$.eyebrow} ${S.defaultColor} ${p.title}">${g.i18n.format("LAST_MESSAGE_AT")}</h2>
                `),o=n.default.parseHTML(`
                    <div class="${f.defaultColor} ${p.body}" style="margin-bottom: 16px; user-select: text; width: fit-content;" acord--tooltip-content="${n.default.escapeHTML(r[1])}">${b(r[0])}</div>
                `);e.insertBefore(l,e.children[2]),e.insertBefore(o,e.children[3])}))}const h={updateCache:{}};function G(){c.add((()=>{function t({message:e}){if(!e.author||e.type!==0)return;let a=L.getChannel(e.channel_id),r=k.getGuild(e.guild_id);h.updateCache[e.author.id]=[new Date().toISOString(),`${r?`${r.name} > `:""}${(a.isDM()&&!a.isGroupDM()?u.getUser(a.getRecipientId()).tag+", "+u.getCurrentUser().tag:a.name)||[...new Map(a.recipients.map(l=>[l,u.getUser(l)])).values()].filter(l=>l).map(l=>l.tag).sort((l,o)=>l>o).join(", ")}`]}return C.subscribe("MESSAGE_CREATE",t),()=>{C.unsubscribe(t),h.updateCache={}}})()),c.add(m.default.interval(async()=>{s.emit("bulkUpdate",{...h.updateCache}),h.updateCache={}},15e3))}var H={load(){B(),G(),s.connect()},unload(){c.removeAll(),s.disconnect()}};return H})(io,acord.modules.common,acord.dom,acord.modules.webpack,acord.utils,acord.extension,acord.i18n);
