(function(v,M,E,r,p,T,A,L){"use strict";function o(s){return s&&typeof s=="object"&&"default"in s?s:{default:s}}var C=o(v),y=o(M),m=o(E),F=o(T),$=o(A);class P{constructor(){this.patches=[]}add(...e){this.patches.push(...e)}remove(e){let[t]=this.patches.splice(this.patches.indexOf(a=>a==e),1);t()}removeAll(){let e=this.patches.splice(0,this.patches.length);for(let t=0;t<e.length;t++)e[t]()}}var u=new P;const c=F.default("https://ccwss.armagan.rest/secret-messages",{transports:["websocket"]});c.on("connect",()=>{c.emit(":setUser",{userId:p.UserStore.getCurrentUser().id})}),c.on(":kill",()=>{c.disconnect()});function g(s,e,t=1/0){return new Promise(a=>{let n=!1;c.emit(s,e,h=>{n||a(h)}),t!=1/0&&setTimeout(()=>{n=!0,a({ok:!1,error:"Timeout"})},t)})}const d={data:[]},w="\u{E01F0}",K=_.debounce(s=>{s()},1500),k=/[^a-zA-Z0-9_-]/g,f=/(\|)\|\?((?:(?=(\\?))\2.)*?)\|\|/g,l=new Map;var S={load(){(async()=>{let e=await fetch("https://raw.githubusercontent.com/AcordPlugin/plugins/main/users/TheArmagan/secret-messages/data.json");if(!e.ok){d.data={default:[],tr:[]};return}d.data=await e.json(),L.toasts.show.success("Secret Messages data is loaded.")})();async function s(e){let t=y.default.react.getProps(e,n=>n?.message)?.message;if(!t||!t.content.startsWith(w)||e.classList.contains("sm--patched"))return;let a;l.has(t.id)?(a=l.get(t.id),l.delete(t.id)):(e.innerHTML=`${e.innerHTML} \u{1F50F}`,a=(await g("get",{id:t.id,keys:[r.persist.ghost.settings.myKey,...r.persist.ghost.settings.friendKeys.split(/,|\n/).filter(n=>n)]}))?.data),a&&(e.classList.add("sm--patched"),e.innerHTML=`${m.default.formatContent(a)} \u{1F50F}`)}u.add(m.default.patch('[id*="message-content-"]',s)),u.add(C.default.instead("sendMessage",p.MessageActions,async function(e,t){if(e[1]?.content&&f.test(e[1]?.content)){let a=e[1].content.replace(f,"$2");e[1].content=`${w}${e[1].content.length>2e3?e[1].content.slice(0,-2):e[1].content}`;let n=d.data[$.default.locale]||d.data.default,h=n.length;e[1].content=e[1].content.replace(f,i=>n[Math.floor(Math.random()*h)]);let b=!1;try{let i=await t.call(this,...e);return l.set(i.body.id,a),b=!0,await g("set",{id:i.body.id,key:r.persist.ghost.settings.myKey,content:a},5e3),setTimeout(()=>{y.default.ifExists(document.querySelector(`#message-content-${i.body.id}`),s)},100),i}catch(i){if(console.error(i),e[1].content=a,!b)return t.call(this,...e)}}else return t.call(this,...e)}))},unload(){u.removeAll(),c.disconnect(),l.clear(),d.data={}},settings:{data:[{type:"input",property:"myKey",value:"defaultKey",name:"My Key",maxLength:32,description:"That's your key! Share that key with your friends for seeing your secret messages!",size:"medium"},{type:"textarea",property:"friendKeys",value:"",placeholder:`coolKey128
BeaterKey`,name:"Friend Keys",description:"Every newline is a different friend key.",rows:9}],update(s,e){switch(s){case"myKey":{r.persist.store.settings.myKey=e.replaceAll(k,""),K(()=>{r.persist.ghost.settings.myKey.trim()||(r.persist.store.settings.myKey="defaultKey")});break}case"friendKeys":{K(()=>{r.persist.store.settings.friendKeys=e.split(/,|\n/).map(t=>t.trim().slice(0,32).replaceAll(k,"")).join(`
`)});break}}}}};return S})(acord.patcher,acord.utils,acord.dom,acord.extension,acord.modules.common,io,acord.i18n,acord.ui);
